<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Microsoft 365 Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-xl mx-auto p-6">
    <h1 class="text-2xl font-bold text-blue-600 mb-6">My Microsoft 365 Profile</h1>
    <div class="flex space-x-2 mb-4">
      <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600 transition">Login</button>
      <button id="logoutBtn" class="hidden bg-gray-500 text-white px-4 py-2 rounded shadow hover:bg-gray-600 transition">Logout</button>
    </div>

    <div id="status" class="text-gray-500 italic mb-4"></div>

    <div id="profile" class="hidden bg-white rounded-lg shadow p-4">
      <dl class="grid grid-cols-1 gap-2">
        <div class="flex"><dt class="font-semibold">Display Name:</dt><dd class="ml-2" id="displayName"></dd></div>
        <div class="flex"><dt class="font-semibold">Email:</dt><dd class="ml-2" id="email"></dd></div>
        <div class="flex"><dt class="font-semibold">Job Title:</dt><dd class="ml-2" id="jobTitle"></dd></div>
        <div class="flex"><dt class="font-semibold">Department:</dt><dd class="ml-2" id="department"></dd></div>
        <div class="flex"><dt class="font-semibold">User Principal Name:</dt><dd class="ml-2" id="userPrincipalName"></dd></div>
      </dl>
    </div>
  </div>

  <script>
    const msalConfig = {
      auth: {
        clientId: '777f7fc2-a83e-43fe-b79e-209fa7b089c9',
        authority: 'https://login.microsoftonline.com/20e27700-b670-4553-a27c-d8e2583b3289',
        redirectUri: window.location.origin
      }
    };

    const loginRequest = { scopes: ['openid', 'profile', 'User.Read', 'offline_access'] };
    const graphEndpoint = 'https://graph.microsoft.com/v1.0/me?$select=displayName,mail,department,onPremisesDepartment,jobTitle,userPrincipalName';

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusDiv = document.getElementById('status');
    const profileDiv = document.getElementById('profile');

    loginBtn.onclick = () => msalInstance.loginRedirect(loginRequest);
    logoutBtn.onclick = () => msalInstance.logoutRedirect({ postLogoutRedirectUri: window.location.origin });

    msalInstance.handleRedirectPromise()
      .then(response => {
        const account = response?.account || msalInstance.getAllAccounts()[0];
        if (account) {
          loginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
          statusDiv.textContent = `Logged in as ${account.username}`;
          fetchProfile(account);
        }
      })
      .catch(err => statusDiv.textContent = 'Authentication error.');

    async function fetchProfile(account) {
      statusDiv.textContent = 'Fetching profile...';
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: loginRequest.scopes, account });
        const res = await fetch(graphEndpoint, {
          headers: { Authorization: `Bearer ${tokenResponse.accessToken}` }
        });

        if (!res.ok) throw new Error('Failed to fetch profile');

        const data = await res.json();
        document.getElementById('displayName').textContent = data.displayName;
        document.getElementById('email').textContent = data.mail || data.userPrincipalName;
        document.getElementById('jobTitle').textContent = data.jobTitle || '(not set)';
        document.getElementById('department').textContent = data.department || data.onPremisesDepartment || '(not set)';
        document.getElementById('userPrincipalName').textContent = data.userPrincipalName;

        profileDiv.classList.remove('hidden');
        statusDiv.textContent = '';
      } catch (e) {
        statusDiv.textContent = 'Error loading profile.';
      }
    }
  </script>
</body>
</html>
