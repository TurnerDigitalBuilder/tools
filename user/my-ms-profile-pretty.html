<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Microsoft 365 Profile</title>
  <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
  <style>
    /* Design Tokens */
    :root {
      --color-primary: #0063b1;
      --color-background: #f0f2f5;
      --color-surface: #ffffff;
      --color-text-primary: #202124;
      --color-text-secondary: #5f6368;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --radius-md: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --transition: 0.3s ease;
    }
    [data-theme="dark"] {
      --color-background: #1a1a1a;
      --color-surface: #2c2c2c;
      --color-text-primary: #e8eaed;
      --color-text-secondary: #a1a1a1;
    }

    body {
      margin: 0;
      padding: var(--space-lg);
      font-family: "Segoe UI", sans-serif;
      background: var(--color-background);
      color: var(--color-text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
    }

    header {
      width: 100%;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }
    h1 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--color-primary);
    }
    .btn {
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding: var(--space-sm) var(--space-md);
      font-size: 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    .toggle-theme {
      background: none;
      font-size: 1.25rem;
    }

    #status {
      margin-top: var(--space-sm);
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      min-height: 1.2em;
      transition: color var(--transition);
    }

    #profile {
      width: 100%;
      max-width: 600px;
      background: var(--color-surface);
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: var(--space-md);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity var(--transition), transform var(--transition);
    }
    #profile.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .field {
      display: contents;
    }
    .label {
      font-weight: 600;
      color: var(--color-text-secondary);
    }
    .value {
      color: var(--color-text-primary);
    }

    /* Spinner */
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-left-color: var(--color-primary);
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      animation: spin 1s linear infinite;
      margin: var(--space-md) auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <h1>My Microsoft 365 Profile</h1>
    <div>
      <button id="loginBtn" class="btn">Login</button>
      <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
      <button id="themeToggle" class="toggle-theme" aria-label="Toggle dark/light mode">ðŸŒ™</button>
    </div>
  </header>

  <div id="status"></div>
  <div id="loader" class="spinner" style="display:none;"></div>
  <div id="profile"></div>

  <script>
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      const root = document.documentElement;
      const current = root.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      themeToggle.textContent = next === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
    });

    const msalConfig = {
      auth: {
        clientId: '4a1add08-6985-47df-bf49-ff14a8f25cdd',
        authority: 'https://login.microsoftonline.com/20e27700-b670-4553-a27c-d8e2583b3289',
        redirectUri: window.location.href
      },
      cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
    };
    const loginRequest = { scopes: ['openid', 'profile', 'User.Read', 'offline_access'] };
    const graphEndpoint = 'https://graph.microsoft.com/v1.0/me?$select=displayName,mail,department,onPremisesDepartment,jobTitle,userPrincipalName';
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusDiv = document.getElementById('status');
    const loader = document.getElementById('loader');
    const profileDiv = document.getElementById('profile');

    loginBtn.addEventListener('click', () => msalInstance.loginRedirect(loginRequest));
    logoutBtn.addEventListener('click', () => msalInstance.logoutRedirect({ postLogoutRedirectUri: window.location.href }));

    msalInstance.handleRedirectPromise()
      .then(res => { const account = res?.account || msalInstance.getAllAccounts()[0]; if (account) initialize(account); })
      .catch(e => { console.error(e); statusDiv.textContent = 'Authentication error.'; });

    function initialize(account) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      statusDiv.textContent = `Logged in as ${account.username}`;
      fetchProfile(account);
    }

    async function fetchProfile(account) {
      try {
        statusDiv.textContent = 'Fetching profile info...';
        loader.style.display = 'block';
        profileDiv.classList.remove('visible');

        const tokenResponse = await msalInstance.acquireTokenSilent({ account, scopes: loginRequest.scopes });
        const res = await fetch(graphEndpoint, { headers: { Authorization: `Bearer ${tokenResponse.accessToken}` } });
        if (!res.ok) throw new Error(res.statusText);
        const profile = await res.json();

        renderProfile(profile);
        statusDiv.textContent = 'Profile loaded';
      } catch (err) {
        console.error(err);
        statusDiv.textContent = 'Error fetching profile, retrying...';
        if (err instanceof msal.InteractionRequiredAuthError) msalInstance.acquireTokenRedirect(loginRequest);
        else statusDiv.textContent = 'Failed to fetch profile.';
      } finally {
        loader.style.display = 'none';
      }
    }

    function renderProfile(profile) {
      const dept = profile.department || profile.onPremisesDepartment || '(not set)';
      profileDiv.innerHTML = `
        <div class="label">Display Name:</div><div class="value">${profile.displayName}</div>
        <div class="label">Email:</div><div class="value">${profile.mail || profile.userPrincipalName}</div>
        <div class="label">Job Title:</div><div class="value">${profile.jobTitle}</div>
        <div class="label">Department:</div><div class="value">${dept}</div>
        <div class="label">UPN:</div><div class="value">${profile.userPrincipalName}</div>
      `;
      profileDiv.classList.add('visible');
    }
  </script>
</body>
</html>
